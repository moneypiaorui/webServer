"use strict";(globalThis.webpackChunkinfinity_hitab_client=globalThis.webpackChunkinfinity_hitab_client||[]).push([[6160],{74891:(t,e,s)=>{s.d(e,{B:()=>p,DX:()=>u,Fh:()=>m,Fw:()=>S,Hb:()=>f,J2:()=>b,KC:()=>I,Vq:()=>L,bI:()=>M,fZ:()=>C,l4:()=>d,lk:()=>l,mr:()=>w,pp:()=>v,sT:()=>P,t1:()=>y,ud:()=>T,wY:()=>A,x:()=>g});var i=s(74003),a=s(17904),n=s(57562),r=s(63477),o=s(89660);let c=i.kP;function d(t){const e=(0,i.XF)("chatAiHost");e&&(c=e),(0,n.b$)("chatai",t)}function h(t,e){(0,n.b$)("chatai",!0);let s="";e instanceof Error?s=e.message:"string"==typeof e&&(s=e),o.k.addEvent("network_error",{host:t,error:s})}const l=async()=>{try{d();const t=await a.hj.get(`${c}chat/list`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},u=async(t,e,s,i)=>{const n=c;try{d();const r=await a.hj.post(`${n}chat/conversation-v2`,{prompt:t,conversationId:e,assistantId:s,model:i},{_auth:!0,_stream:!0,fetchOpts:{timeout:3e4}});return r||h(n),[null,r]}catch(t){return h(n,t),["catch error"]}},p=async(t,e,s)=>{const i=c;try{d();const n=await a.hj.post(`${i}chat/regenerate-v2`,{conversationId:t,assistantId:e,model:s},{_auth:!0,_stream:!0,fetchOpts:{timeout:3e4}});return n||h(i),[null,n]}catch(t){return h(i,t),["catch error"]}},v=async(t,e)=>{d();const s=c;try{const i=await a.hj.get(`${s}chat/history`,{pageNo:t,pageSize:e},{_auth:!0,timeout:5e3});if(0===i.code&&i.data)return[null,i.data];throw h(s,i.message),i}catch(t){return h(s,t),["catch error"]}},g=async t=>{try{d();const e=await a.hj.post(`${c}chat/delete`,{conversationId:t},{_auth:!0});if(0===e.code&&e.data)return[null,e.data];throw e}catch(t){return["catch error"]}},m=async()=>{try{d();const t=await a.hj.get(`${c}chat/recommended`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},L=async()=>{try{d();const t=await a.hj.get(`${c}chat/assistant-list`,{},{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},y=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/plan-v3`,{},{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},f=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/pay-platform`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},w=async(t,e)=>{try{const s=await a.hj.post(`${i.H}chat-pay/create-order`,{planId:t,payPlatform:e},{_auth:!0});if(0===s.code&&s.data)return[null,s.data];if(5006===s.code)return[s.message||"创建订单失败!",null];throw s}catch(t){return["无法购买!"]}},I=async()=>{try{const t=await a.hj.post(`${i.H}chat-pay/check-order`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},T=async t=>{try{const e=await a.hj.post(`${i.H}chat-pay/check-order-ids`,{ids:t},{_auth:!0});if(0===e.code&&e.data)return[null,e.data];throw e}catch(t){return["catch error"]}},S=async t=>{try{const e=await a.hj.get(`${i.H}chat-pay/order-list`,{check:t},{_auth:!0});if(0===e.code&&e.data){return[null,{list:e.data.list.map((t=>(t.paySuccessTimStr=(0,r.F8)(t.paySuccessTime),t.payAmount=`¥${t.payAmount}`,t)))}]}throw e}catch(t){return["catch error"]}},P=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/vip-group`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},C=async()=>{try{const t=await a.hj.get(`${i.H}chat/models`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data.list];throw t}catch(t){return["catch error"]}},M=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/order-detail`,void 0,{_auth:!0});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}},A=async t=>{try{const e=await a.hj.post(`${i.H}chat-pay/confirm-modify-plan`,{orderId:t},{_auth:!0});if(0===e.code&&e.data)return[null,e.data];throw e}catch(t){return["catch error"]}},b=async()=>{try{const t=await a.hj.get(`${i.H}chat-pay/plan-double11`,{});if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}}},36160:(t,e,s)=>{s.r(e),s.d(e,{NEWCHAT_ID:()=>C,useChatGptStore:()=>b});var i=s(10435),a=s(95329),n=s(74891),r=s(84522),o=s(80661),c=s(77363),d=s(60385),h=s(54348);const l=function(t){return function(e,s,i){var a=Object(e);if(!(0,d.Z)(e)){var n=(0,c.Z)(s,3);e=(0,h.Z)(e),s=function(t){return n(a[t],t,a)}}var r=t(e,s,i);return r>-1?a[n?e[r]:r]:void 0}};var u=s(30967);const p=l(u.Z);var v=s(46146),g=s(60275),m=Math.max;const L=function(t,e,s){var i=null==t?0:t.length;if(!i)return-1;var a=null==s?0:(0,g.Z)(s);return a<0&&(a=m(i+a,0)),(0,v.Z)(t,(0,c.Z)(e,3),a)};var y=s(82410),f=s(88514),w=s(63477),I=s(13889);const T=new class{splitter="_e79218965e_";constructor(){this.restString=""}parser(t){const e=(this.restString+t).split(this.splitter).filter((t=>!!t));this.restString="";const s=[];return e.forEach(((e,i)=>{try{const t=JSON.parse(e);s.push(t)}catch(s){i===t.length-1&&(this.restString=e)}})),s}};var S=s(17319);const P=(0,a.useUserStore)(),C="newChat",M=()=>({name:"新的聊天",id:C,messages:[],updateTime:o().format("YYYY-MM-DD HH:mm")}),A=new class{constructor(t,e,s){this.state=e,this.type=t;const i=`${t}-retrieve`;I.y.listen(t,(t=>{this.state=t,null==s||s(t)})),I.y.listen(i,(()=>{I.y.post(t,this.state)})),setTimeout((()=>{I.y.post(i,null)}),50)}getState(){return this.state}setState(t){this.state=t,I.y.post(this.type,t)}}("client:chatai-pending",{pending:!1},(function(t){t.pending||k()})),b=(0,i.Q_)(r.BU.chatgpt,{syncStorage:{watch:["customLinks","panelType","linksList","chatTips","conversionList","planList","overLimit","historyTipsReaded","chatAssistantList","removedList","theme","vipGroup","closedExpiredTime","chatModelList","double11PlanList"]},syncCloud:{watch:["customLinks","panelType","historyTipsReaded","theme","closedExpiredTime"]},state:()=>({modalShow:!1,linksList:[],selectedLink:null,panelType:"chatai",customLinks:[],conversionList:[M()],activeConversionId:C,chatTips:"世界上有多少人口？",pending:!1,chatLoading:!1,pagination:{pageNo:0,loading:!1,finished:!1},sponsorShow:!1,controller:null,tempId:void 0,planList:[],planSelectedIndex:0,vipTipsShow:!1,vipTipsContent:"",overLimit:0,vipGroup:void 0,historyTipsReaded:!1,chatAssistantList:[],activeAssistantId:"",assistantListShow:!1,removedList:[],theme:"",panelShowType:"",orderList:[],closedExpiredTime:0,isRequestPage:!1,paymentOrderData:null,localCurrentTime:0,createOrderParams:{planId:"",payPlatform:""},payOrderIds:new Set,chatModelList:[],selectedModel:null,chatVipDetail:{name:"",rest:{"3d5":-1,4:-1}},isFreeOrder:!1,double11PlanList:[],double11PlanSelect:0,fromTag:"",firstReq:!0}),getters:{conversionDataList(){return this.conversionList.map((t=>{var e,s;return{...t,name:(null===(e=t.messages[0])||void 0===e?void 0:e.content)||"新的聊天",updateTime:o(null===(s=t.messages[0])||void 0===s?void 0:s.updateTime).format("YYYY-MM-DD HH:mm")}}))},activeConversionItemOrigin(){const t=this.conversionList.find((t=>t.id===this.activeConversionId));return t||M()},assistantListMapper(){const t={};return this.chatAssistantList&&this.chatAssistantList.forEach((e=>{t[e.id]=e})),t},activeConversionItem(){const t=this.activeConversionItemOrigin;let e=null;return t.messages=t.messages.map((t=>{if("user"===t.role){e!==t.assistantId&&(t.newAssistant=!0),e=t.assistantId;const s=this.assistantListMapper[e];e&&t.newAssistant&&s?(t.assistantLogo=s.logo,t.assistantTitle=s.title):!t.newAssistant||e&&s||(t.assistantLogo=void 0,t.assistantTitle=void 0)}else if("assistant"===t.role){t.assistantId=e;const s=this.assistantListMapper[e];e&&s&&(t.assistantLogo=s.logo)}return t})),t},userOperationDisabled(){return!P.isLogin||this.pending||this.chatLoading},activeAssistant(){var t;return null===(t=this.chatAssistantList)||void 0===t?void 0:t.find((t=>t.id===this.activeAssistantId))},activeTheme(){return(0,a.useUserStore)().chatStatus.vip?this.theme?this.theme:"chat-purple":"chat-default"},activeSelectModel(){if(this.selectedModel)return this.selectedModel;const t=this.chatModelList.find((t=>t.default));return t||(this.chatModelList.length>0?this.chatModelList[0]:{abbName:"",id:"",name:"",limitKey:""})},operationDisabled(){let t=!1;return this.conversionDataList.forEach((e=>{e.messages.find((t=>t.loading||t.pending))&&(t=!0)})),t},currentPlanList(){var t;return(null===(t=this.planList[this.planSelectedIndex])||void 0===t?void 0:t.children)||[]},double11CurrentPlan(){var t;return null===(t=this.double11PlanList[this.double11PlanSelect])||void 0===t?void 0:t.children},double11PricePanel(){return this.double11PlanList.map((t=>`${t.title} ${t.discountStr}`))}},actions:{setModal(t){this.modalShow=t},setPanelType(t){this.panelType=t},setPanelShowType(t){this.panelShowType=t,"chat-expense"===this.panelType&&this.setPanelType("chatai")},setSelectLink(t){this.selectedLink=t},setVipGroup(t){this.vipGroup=t},addCustomLink(t){const e=[...this.customLinks];e.push(t),this.customLinks=e},removeCustomLink(t){const e=[...this.customLinks];e.splice(t,1),this.customLinks=e},removeOriginLink(t){t&&(this.removedList.unshift(t),this.removedList.length>10&&(this.removedList.length=10),this.removedList=[...this.removedList])},setActiveConversionId(t){this.activeConversionId=t},async deleteConversionItem(t){if(this.conversionList=this.conversionList.filter((e=>e.id!==t)),t===this.activeConversionId&&(this.conversionDataList.length>0?this.activeConversionId=this.conversionDataList[0].id:this.newChatHandler()),!this.isServerId(t))return;const[e,s]=await(0,n.x)(t)},newChatHandler(){const t={name:"新的聊天",id:C,messages:[],updateTime:o().format("YYYY-MM-DD HH:mm")};this.conversionList=[t,...this.conversionList],this.activeConversionId=C,this.activeAssistantId=""},async reqGptLinks(){const[t,e]=await(0,n.lk)();!t&&e&&(this.linksList=e,this.selectedLink=e[0])},resetPage(){this.conversionList=[M()],this.activeConversionId=C,this.planList=[],this.planSelectedIndex=0,this.overLimit=0,this.vipGroup=void 0,this.pagination={pageNo:0,loading:!1,finished:!1}},async reqConversionList(t){var e;if(A.getState().pending)return void(this.activeConversionId=(null===(e=this.conversionList[0])||void 0===e?void 0:e.id)||C);if(this.pagination.loading||this.pagination.finished)return;this.pagination={...this.pagination,loading:!0};const[s,i]=await(0,n.pp)(this.pagination.pageNo);if(!s&&i){var a;if(t)this.conversionList=[M(),...i.list];else if(this.conversionList=[...this.conversionList,...i.list],this.activeConversionId===C)this.activeConversionId=(null===(a=i.list[0])||void 0===a?void 0:a.id)||C;i.totalPages-i.pageNo<=1?this.pagination={...this.pagination,finished:!0,loading:!1}:this.pagination={pageNo:i.pageNo+1,loading:!1,finished:!1}}},addUserMessage(t,e){const s=[...this.conversionList],i=s.find((t=>t.id===e));null==i||i.messages.push({role:"user",content:t,updateTime:o().valueOf(),assistantId:this.activeAssistantId||void 0}),this.conversionList=s},onClickTryIt(){this.sendChatMessage(this.chatTips,C)},async reqChatTips(){const[t,e]=await(0,n.Fh)();!t&&e&&(this.chatTips=e)},async reqAssistantList(){const[t,e]=await(0,n.Vq)();!t&&e&&(this.chatAssistantList=e)},updatePendingMessage(t){const e=[...this.conversionList],s=e.find((e=>e.id===t.conversionId)),i=s.messages.find((t=>t.loading));i&&(i.loading=!1,i.pending=!0),this.pending=!0,A.setState({pending:!0});const a=s.messages.find((t=>t.pending));if(t.error)return a.error=!0,a.content=t.content,a.pending=!1,a.extra=t.showNewBtn,this.pending=!1,this.conversionList=e,A.setState({pending:!1}),void(this.isRequestPage=!1);t.done&&(a.pending=!1,this.isServerId(t.conversionId)||t.id&&(s.id=t.id,this.activeConversionId=t.id),t.modelId&&(a.modelId=t.modelId),this.pending=!1,A.setState({pending:!1}),this.isRequestPage=!1),t.id&&(this.tempId=t.id),a.content+=t.content,this.conversionList=e},createLoadingMsg(t){const e=[...this.conversionList];e.find((e=>e.id===t)).messages.push({role:"assistant",content:"",loading:!0}),this.conversionList=e},setNewLocalId(){const t=this.conversionList.find((t=>t.id===C&&t.messages.length>0));t&&(t.id=this.createLocalId(),this.conversionList=[...this.conversionList])},createLocalId:()=>(0,w.kb)(C),isServerId:t=>!!t&&!t.startsWith(C),async sendChatMessage(t,e){if(this.operationDisabled)return void S.R.warn({message:"请等待当前对话完成..."});this.chatLoading=!0,this.controller=null;if(!this.conversionList.find((t=>t.id===e))){var s;let t=null===(s=this.conversionList[0])||void 0===s?void 0:s.id;t||(t=C,this.newChatHandler()),this.activeConversionId=t,e=t}this.addUserMessage(t,e),this.createLoadingMsg(e);const i=this.isServerId(e)?e:void 0,[a,r]=await(0,n.DX)(t,i,this.activeAssistantId,this.activeSelectModel.id);if(a||!r)return void this.updatePendingMessage({conversionId:e,content:"网络错误，请重试",error:!0,done:!0});this.isRequestPage=!0;const[o,c]=r;c&&(this.controller=c),this.chatLoading=!1,this.streamReaderToText(o,e)},readStreamWithTimeout:(t,e)=>new Promise(((s,i)=>{const a=setTimeout((()=>{i(new f.V("timeout"))}),e);t.read().then((t=>{clearTimeout(a),s(t)})).catch((t=>{clearTimeout(a),i(t)}))})),async streamReaderToText(t,e){try{const s=await this.readStreamWithTimeout(t,2e5);if(s.done)return;const i=s.value;let a="";a=new TextDecoder("utf-8").decode(i);const n=T.parser(a);this.handleChunksArray(n,e),this.streamReaderToText(t,e)}catch(t){this.isRequestPage=!1,A.setState({pending:!1}),"object"==typeof t&&(t instanceof f.V?this.abourtStream():null==t||t.name)}},deleteLastMessage(t,e){const s=[...this.conversionList],i=s.find((t=>t.id===e)),a=(0,u.Z)(i.messages,(e=>e.role===t));i.messages.splice(a,1),this.conversionList=s},updateLatestUserMessage(t){const e=[...this.conversionList],s=e.find((e=>e.id===t)),i=(0,u.Z)(null==s?void 0:s.messages,(t=>"user"===t.role));i>-1&&(s.messages[i].assistantId=this.activeAssistantId||void 0),this.conversionList=e},async reGenerateLastAnwser(t){if(this.operationDisabled)return void S.R.warn({message:"请等待当前对话完成..."});this.controller=null,this.chatLoading=!0;const e=[...this.conversionList].find((e=>e.id===t)),s=e.messages.find((t=>t.error));if(this.deleteLastMessage("assistant",t),s){const s=p(e.messages,(t=>"user"===t.role)).content;return this.deleteLastMessage("user",t),void this.sendChatMessage(s,t)}this.createLoadingMsg(t),this.updateLatestUserMessage(t);const[i,a]=await(0,n.B)(t,this.activeAssistantId,this.activeSelectModel.id);if(i||!a)return void this.updatePendingMessage({conversionId:t,content:"网络错误，请重试",error:!0,done:!0});this.isRequestPage=!0;const[r,o]=a;o&&(this.controller=o),this.chatLoading=!1,this.streamReaderToText(r,t)},handleChunksArray(t,e){t.forEach((t=>{switch(t.code){case 0:const{content:s,id:i}=t.data;this.updatePendingMessage({conversionId:e,content:s,id:i||""});break;case 5001:this.updatePendingMessage({conversionId:e,content:"",id:t.data.conversationId,modelId:t.data.modelId,done:!0}),t.data.restCount&&this.updateRestCount(t.data.restCount);break;case 4002:P.getProfile(),this.updatePendingMessage({conversionId:e,content:"系统错误，请重试",error:!0,done:!0});break;case 5002:this.setVipTipsShow(!0,"今日免费体验额度已达到上限"),this.setOverLimit(Date.now()),this.updatePendingMessage({conversionId:e,content:t.message||"系统错误",error:!0,done:!0});break;case 5003:case 1001:this.updatePendingMessage({conversionId:e,content:t.message||"系统错误",error:!0,done:!0});break;case 5004:this.updatePendingMessage({conversionId:e,content:t.message||"系统错误",error:!0,done:!0,showNewBtn:!0});break;default:this.updatePendingMessage({conversionId:e,content:t.message||"系统错误，请稍后重试",error:!0,done:!0})}}))},setSponsorShow(t){this.sponsorShow=t},setVipTipsShow(t,e){this.vipTipsShow=t,this.vipTipsContent=e},setOverLimit(t){this.overLimit=t},abourtStream(){this.controller&&(this.controller.abort(),this.controller=null,this.updatePendingMessage({conversionId:this.activeConversionId,content:"",id:this.tempId,done:!0}))},async getPlanList(){const[t,e]=await(0,n.t1)();!t&&e&&(this.planList=e.list||[],this.firstReq&&(this.planSelectedIndex=e.select,this.firstReq=!1))},setPlanSelectedIndex(t){this.planSelectedIndex=t},async getPayCode(t,e){const[s,i]=await(0,n.mr)(t,e);if(!s)return i},async getPayList(){const[t,e]=await(0,n.Hb)();if(!t)return e},async checkAllOrders(){const[t,e]=await(0,n.KC)(),s=e.chatai||{};return null===t&&(P.setChatStatus(s),s.vip)},async checkRecentOrderIds(t){const[e,s]=await(0,n.ud)(t);return null!==e?"":s.paidId},async getVipGroup(){const[t,e]=await(0,n.sT)();null===t&&this.setVipGroup(e)},readHistoryTips(){this.historyTipsReaded=!0},setActiveAssistant(t){this.activeAssistantId=t},setActiveAssistantToNext(){const t=L(this.chatAssistantList,(t=>t.id===this.activeAssistantId));t>-1?t===this.chatAssistantList.length-1?this.activeAssistantId="":this.activeAssistantId=this.chatAssistantList[t+1].id:this.activeAssistantId=this.chatAssistantList[0].id},setActiveAssistantToPrev(){const t=L(this.chatAssistantList,(t=>t.id===this.activeAssistantId));this.activeAssistantId=t>-1?0===t?"":this.chatAssistantList[t-1].id:this.chatAssistantList[this.chatAssistantList.length-1].id},setAssistantListStatus(t){var e;t&&null!==(e=this.chatAssistantList)&&void 0!==e&&e.length?this.assistantListShow=!0:this.assistantListShow=t},setStreamTimeout(t,e){this.updatePendingMessage({conversionId:t,content:"",id:this.tempId,done:!0,error:e})},setTheme(t){this.theme=t},async reqOrderList(t){const[e,s]=await(0,n.Fw)(t);null===e&&(this.orderList=s.list)},closeChatVipExpired(t){this.closedExpiredTime=t},unloadUpdatePending(){A.getState().pending&&this.isRequestPage&&A.setState({pending:!1})},mutTabspendingOver(){if(this.activeConversionId===C){this.conversionList.find((t=>t.id===C))||(this.activeConversionId=this.conversionList[0].id)}this.releasePending()},setCreateOrderParams(t){this.createOrderParams=t},async createPaymentOrder(t,e){const[s,i]=await(0,n.mr)(t,e);if(s)throw S.R.fail({message:s}),new Error(s);return this.paymentOrderData=i,this.isFreeOrder=0===this.paymentOrderData.newPlan.payAmount,this.localCurrentTime=Date.now(),this.payOrderIds.add(i.orderId),i},clearOrderIds(){this.payOrderIds.clear()},async getChatModels(){const[t,e]=await(0,n.fZ)();if(t||!e)return;const s=e.find((t=>t.default));s&&(this.selectedModel=s),this.chatModelList=e},setSelectModel(t){this.selectedModel=t},async getUserVipDetail(){const[t,e]=await(0,n.bI)();!t&&e&&(this.chatVipDetail=e)},async confirmChangePlanForFree(){if(!this.paymentOrderData)return;const[t,e]=await(0,n.wY)(this.paymentOrderData.orderId)},updateRestCount(t){this.chatVipDetail={...this.chatVipDetail,rest:t}},releasePending(){const t=[...this.conversionList];let e=!1;t.forEach((t=>{const s=t.messages.find((t=>t.loading||t.pending));s&&(e=!0,s.loading=!1,s.pending=!1)})),e&&(this.conversionList=t)},async reqDouble11PlanList(){const[t,e]=await(0,n.J2)();!t&&e&&(this.double11PlanList=e.list,this.double11PlanSelect=e.select)},setDouble11PlanSelect(t){this.double11PlanSelect=t},setFromTag(t){this.fromTag=t}}});window.addEventListener("beforeunload",(()=>(b().unloadUpdatePending(),!0)));const k=(0,y.Z)(b().mutTabspendingOver,100)},88514:(t,e,s)=>{s.d(e,{V:()=>a,o:()=>i});const i=t=>{document.body.classList.remove("chat-default","chat-purple","chat-white"),document.body.classList.add(t)};class a extends Error{}},30967:(t,e,s)=>{s.d(e,{Z:()=>c});var i=s(46146),a=s(77363),n=s(60275),r=Math.max,o=Math.min;const c=function(t,e,s){var c=null==t?0:t.length;if(!c)return-1;var d=c-1;return void 0!==s&&(d=(0,n.Z)(s),d=s<0?r(c+d,0):o(d,c-1)),(0,i.Z)(t,(0,a.Z)(e,3),d,!0)}}}]);